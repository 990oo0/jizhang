<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="禽易记">
    <title>禽易记 - 家禽批发记账系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a86e8;
            --secondary-color: #f8f9fa;
            --accent-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc05;
            --text-color: #333;
            --light-text: #666;
            --border-color: #ddd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            color: var(--text-color);
            padding-bottom: 70px;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .stat-box {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 12px;
            width: 48%;
        }
        
        .stat-title {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .quick-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .action-btn {
            background-color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .action-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .action-btn:nth-child(1) i {
            color: var(--accent-color);
        }
        
        .action-btn:nth-child(2) i {
            color: var(--primary-color);
        }
        
        .action-btn:nth-child(3) i {
            color: var(--warning-color);
        }
        
        .action-btn:nth-child(4) i {
            color: #9c27b0;
        }
        
        .action-label {
            font-size: 10px;
            text-align: center;
        }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .item-detail {
            font-size: 12px;
            color: var(--light-text);
        }
        
        .item-value {
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
        }
        
        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }
        
        .badge-success {
            background-color: #e8f5e9;
            color: var(--accent-color);
        }
        
        .badge-warning {
            background-color: #fff8e1;
            color: var(--warning-color);
        }
        
        .progress-bar {
            height: 6px;
            background-color: #f5f5f5;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            border-radius: 3px;
        }
        
        .progress-green {
            background-color: var(--accent-color);
        }
        
        .progress-yellow {
            background-color: var(--warning-color);
        }
        
        .progress-orange {
            background-color: #ff9800;
        }
        
        .nav-bar {
            background-color: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item:not(.active) {
            color: #999;
        }
        
        /* Form styles */
        .form-container {
            padding: 20px;
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            font-weight: 500;
            color: var(--light-text);
            font-size: 12px;
        }
        
        /* Screens */
        .screen {
            display: none;
        }
        
        #home-screen {
            display: block;
        }
        
        /* Add/Edit Forms */
        #purchase-form, #sale-form, #customer-form, #report-screen {
            display: none;
        }
        
        /* 空内容提示样式 */
        .empty-hint {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>禽易记</h1>
    </div>
    
    <!-- 主屏幕 -->
    <div id="home-screen" class="screen">
        <div class="container">
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-title">今日销售额</div>
                    <div class="stat-value">¥0.00</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">未结账款</div>
                    <div class="stat-value">¥0.00</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <div class="action-btn" onclick="showScreen('purchase-form')">
                    <i class="fas fa-plus"></i>
                    <div class="action-label">进货</div>
                </div>
                <div class="action-btn" onclick="showScreen('sale-form')">
                    <i class="fas fa-shopping-cart"></i>
                    <div class="action-label">销售</div>
                </div>
                <div class="action-btn" onclick="showScreen('payment-form')">
                    <i class="fas fa-money-bill-wave"></i>
                    <div class="action-label">结账</div>
                </div>
                <div class="action-btn" onclick="showScreen('customer-form')">
                    <i class="fas fa-user"></i>
                    <div class="action-label">客户</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span>商品库存</span>
                    <small><a href="#" onclick="showScreen('inventory-screen')">查看全部</a></small>
                </div>
                <div id="inventory-list">
                    <p class="empty-hint">暂无库存数据，请先添加商品进货</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span>最近交易</span>
                    <small><a href="#" onclick="showScreen('transactions-screen')">查看全部</a></small>
                </div>
                <div id="recent-transactions">
                    <p class="empty-hint">暂无交易记录，请先添加销售数据</p>
                </div>
            </div>
        </div>
    </div>
    <!-- 进货表单 -->
    <div id="purchase-form" class="screen">
        <div class="container">
            <a href="#" class="back-link" onclick="showScreen('home-screen')"><i class="fas fa-arrow-left"></i> 返回首页</a>
            <div class="card">
                <div class="card-title">新增进货记录</div>
                <form id="new-purchase">
                    <div class="form-group">
                        <label class="form-label">商品类型</label>
                        <input type="text" class="form-control" id="purchase-product" placeholder="输入商品类型">
                    </div>
                    <div class="form-group">
                        <label class="form-label">进货数量</label>
                        <input type="number" class="form-control" id="purchase-quantity" placeholder="输入数量">
                    </div>
                    <div class="form-group">
                        <label class="form-label">进货单价(元)</label>
                        <input type="number" step="0.1" class="form-control" id="purchase-price" placeholder="输入单价">
                    </div>
                    <div class="form-group">
                        <label class="form-label">供应商</label>
                        <input type="text" class="form-control" id="purchase-supplier" placeholder="输入供应商名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">进货日期</label>
                        <input type="date" class="form-control" id="purchase-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="purchase-notes" placeholder="可选备注信息"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveData('purchase')">保存记录</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 销售表单 -->
    <div id="sale-form" class="screen">
        <div class="container">
            <a href="#" class="back-link" onclick="showScreen('home-screen')"><i class="fas fa-arrow-left"></i> 返回首页</a>
            <div class="card">
                <div class="card-title">新增销售记录</div>
                <form id="new-sale">
                    <div class="form-group">
                        <label class="form-label">客户</label>
                        <input type="text" class="form-control" id="sale-customer" placeholder="输入客户名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">商品类型</label>
                        <input type="text" class="form-control" id="sale-product" placeholder="输入商品类型">
                    </div>
                    <div class="form-group">
                        <label class="form-label">销售数量</label>
                        <input type="number" class="form-control" id="sale-quantity" placeholder="输入数量">
                    </div>
                    <div class="form-group">
                        <label class="form-label">销售单价(元)</label>
                        <input type="number" step="0.1" class="form-control" id="sale-price" placeholder="输入单价">
                    </div>
                    <div class="form-group">
                        <label class="form-label">是否结账</label>
                        <select class="form-select" id="sale-payment">
                            <option value="已结清">已全部结清</option>
                            <option value="未结账">未结账</option>
                            <option value="部分结账">部分结账</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">销售日期</label>
                        <input type="date" class="form-control" id="sale-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="sale-notes" placeholder="可选备注信息"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveData('sale')">保存记录</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 客户表单 -->
    <div id="customer-form" class="screen">
        <div class="container">
            <a href="#" class="back-link" onclick="showScreen('home-screen')"><i class="fas fa-arrow-left"></i> 返回首页</a>
            <div class="card">
                <div class="card-title">客户管理</div>
                <div id="customer-list">
                    <!-- 客户列表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="card">
                <div class="card-title">添加新客户</div>
                <form id="new-customer">
                    <div class="form-group">
                        <label class="form-label">客户名称</label>
                        <input type="text" class="form-control" id="customer-name" placeholder="输入客户名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">联系人</label>
                        <input type="text" class="form-control" id="customer-contact" placeholder="输入联系人姓名">
                    </div>
                    <div class="form-group">
                        <label class="form-label">联系电话</label>
                        <input type="tel" class="form-control" id="customer-phone" placeholder="输入联系电话">
                    </div>
                    <div class="form-group">
                        <label class="form-label">地址</label>
                        <textarea class="form-control" id="customer-address" placeholder="输入地址信息"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="customer-notes" placeholder="可选备注信息"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveData('customer')">保存客户</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 结账表单 -->
    <div id="payment-form" class="screen">
        <div class="container">
            <a href="#" class="back-link" onclick="showScreen('home-screen')"><i class="fas fa-arrow-left"></i> 返回首页</a>
            <div class="card">
                <div class="card-title">客户结账</div>
                <form id="new-payment">
                    <div class="form-group">
                        <label class="form-label">选择客户</label>
                        <select class="form-select" id="payment-customer">
                            <!-- 客户选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">欠款总额</label>
                        <input type="text" class="form-control" id="payment-debt" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">结账金额</label>
                        <input type="number" step="0.01" class="form-control" id="payment-amount" placeholder="输入结账金额">
                    </div>
                    <div class="form-group">
                        <label class="form-label">结账方式</label>
                        <select class="form-select" id="payment-method">
                            <option value="现金">现金</option>
                            <option value="银行转账">银行转账</option>
                            <option value="微信支付">微信支付</option>
                            <option value="支付宝">支付宝</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">结账日期</label>
                        <input type="date" class="form-control" id="payment-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="payment-notes" placeholder="可选备注信息"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="processPayment()">确认结账</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 设置界面 -->
    <div id="settings-screen" class="screen">
        <div class="container">
            <a href="#" class="back-link" onclick="showScreen('home-screen')"><i class="fas fa-arrow-left"></i> 返回首页</a>
            <div class="card">
                <div class="card-title">系统设置</div>
                <div class="form-group">
                    <label class="form-label">数据备份</label>
                    <button type="button" class="btn btn-primary" onclick="exportData()">导出数据</button>
                </div>
                <div class="form-group">
                    <label class="form-label">数据恢复</label>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('import-file').click()">导入数据</button>
                </div>
                <div class="form-group" style="margin-top: 30px;">
                    <button type="button" class="btn btn-danger" onclick="if(confirm('确定要清除所有数据吗？此操作不可恢复!')) { localStorage.removeItem('poultryData'); location.reload(); }">清除所有数据</button>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">关于禽易记</div>
                <p style="padding: 10px 0;">禽易记 v1.0.0</p>
                <p style="padding: 0 0 10px 0;">家禽批发专用记账系统</p>
                <p style="padding: 0 0 10px 0; font-size: 12px; color: #666;">© 2025 禽易记</p>
            </div>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('home-screen')">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </div>
        <div class="nav-item" onclick="showTransactions()">
            <i class="fas fa-exchange-alt"></i>
            <span>交易</span>
        </div>
        <div class="nav-item" onclick="showScreen('customer-form')">
            <i class="fas fa-users"></i>
            <span>客户</span>
        </div>
        <div class="nav-item" onclick="showReports()">
            <i class="fas fa-chart-bar"></i>
            <span>报表</span>
        </div>
        <div class="nav-item" onclick="showScreen('settings-screen')">
            <i class="fas fa-cog"></i>
            <span>设置</span>
        </div>
    </div>
    
    <script>
        // 设置默认日期为今天
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            
            if(document.getElementById('purchase-date')) {
                document.getElementById('purchase-date').value = today;
            }
            
            if(document.getElementById('sale-date')) {
                document.getElementById('sale-date').value = today;
            }
            
            if(document.getElementById('payment-date')) {
                document.getElementById('payment-date').value = today;
            }
            
            // 检查是否存在本地存储的数据
            initializeLocalStorage();
            
            // 初始加载数据
            updateDashboard();
            updateCustomerList();
            updatePaymentCustomerList();
        });
        
        // 初始化本地存储
        function initializeLocalStorage() {
            if(!localStorage.getItem('poultryData')) {
                const initialData = {
                    purchases: [],
                    sales: [],
                    customers: [],
                    inventory: []
                };
                localStorage.setItem('poultryData', JSON.stringify(initialData));
            }
        }
        
        // 切换不同屏幕
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.style.display = 'none';
            });
            
            document.getElementById(screenId).style.display = 'block';
            
            // 更新导航栏高亮
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // 根据屏幕ID高亮相应的导航项
            if(screenId === 'home-screen') {
                navItems[0].classList.add('active');
            } else if(screenId.includes('sale') || screenId.includes('purchase') || screenId === 'transactions-screen') {
                navItems[1].classList.add('active');
            } else if(screenId.includes('customer')) {
                navItems[2].classList.add('active');
            } else if(screenId.includes('report')) {
                navItems[3].classList.add('active');
            } else if(screenId.includes('settings')) {
                navItems[4].classList.add('active');
            }
            
            // 如果是结账界面，更新客户欠款
            if(screenId === 'payment-form') {
                updateSelectedCustomerDebt();
            }
        }
        
        // 显示交易页面
        function showTransactions() {
            alert('交易记录功能正在开发中');
        }
        
        // 显示报表页面
        function showReports() {
            alert('报表功能正在开发中');
        }
        
        // 保存数据
        function saveData(type) {
            // 获取现有数据
            let data = JSON.parse(localStorage.getItem('poultryData'));
            
            if(type === 'purchase') {
                const productName = document.getElementById('purchase-product').value.trim();
                const quantity = parseInt(document.getElementById('purchase-quantity').value);
                const price = parseFloat(document.getElementById('purchase-price').value);
                
                // 验证数据
                if(!productName || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
                    alert('请填写有效的商品、数量和价格信息！');
                    return;
                }
                
                const purchase = {
                    product: productName,
                    quantity: quantity,
                    price: price,
                    supplier: document.getElementById('purchase-supplier').value,
                    date: document.getElementById('purchase-date').value,
                    notes: document.getElementById('purchase-notes').value,
                    timestamp: new Date().getTime()
                };
                
                // 更新库存
                const inventoryIndex = data.inventory.findIndex(item => item.product === purchase.product);
                if(inventoryIndex !== -1) {
                    // 更新现有商品库存
                    const oldStock = data.inventory[inventoryIndex].stock;
                    const oldCost = data.inventory[inventoryIndex].cost;
                    const newStock = oldStock + purchase.quantity;
                    
                    // 计算加权平均成本
                    const totalCost = oldStock * oldCost + purchase.quantity * purchase.price;
                    const weightedCost = totalCost / newStock;
                    
                    data.inventory[inventoryIndex].stock = newStock;
                    data.inventory[inventoryIndex].cost = Math.round(weightedCost * 10) / 10;
                } else {
                    // 添加新商品
                    data.inventory.push({
                        product: purchase.product,
                        stock: purchase.quantity,
                        cost: purchase.price,
                        price: Math.round(purchase.price * 1.12 * 10) / 10 // 默认加价12%
                    });
                }
                
                // 添加到进货记录
                data.purchases.push(purchase);
                localStorage.setItem('poultryData', JSON.stringify(data));
                
                alert('进货记录保存成功!');
                document.getElementById('new-purchase').reset();
                showScreen('home-screen');
                updateDashboard();
                
            } else if(type === 'sale') {
                const customerName = document.getElementById('sale-customer').value.trim();
                const productName = document.getElementById('sale-product').value.trim();
                const quantity = parseInt(document.getElementById('sale-quantity').value);
                const price = parseFloat(document.getElementById('sale-price').value);
                
                // 验证数据
                if(!customerName || !productName || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
                    alert('请填写有效的客户、商品、数量和价格信息！');
                    return;
                }
                
                // 检查客户是否存在，如果不存在则提示添加
                const customerExists = data.customers.some(c => c.name === customerName);
                if(!customerExists) {
                    if(confirm(`客户"${customerName}"不存在，是否添加新客户？`)) {
                        showScreen('customer-form');
                        document.getElementById('customer-name').value = customerName;
                        return;
                    }
                }
                
                const sale = {
                    customer: customerName,
                    product: productName,
                    quantity: quantity,
                    price: price,
                    payment: document.getElementById('sale-payment').value,
                    date: document.getElementById('sale-date').value,
                    notes: document.getElementById('sale-notes').value,
                    timestamp: new Date().getTime()
                };
                
                // 检查库存是否足够
                const inventoryIndex = data.inventory.findIndex(item => item.product === sale.product);
                if(inventoryIndex === -1) {
                    alert(`商品"${sale.product}"尚未进货，请先添加进货记录！`);
                    return;
                }
                
                if(data.inventory[inventoryIndex].stock < sale.quantity) {
                    alert(`库存不足，当前${sale.product}库存为${data.inventory[inventoryIndex].stock}个！`);
                    return;
                }
                
                // 更新库存
                data.inventory[inventoryIndex].stock -= sale.quantity;
                
                // 添加到销售记录
                data.sales.push(sale);
                localStorage.setItem('poultryData', JSON.stringify(data));
                
                alert('销售记录保存成功!');
                document.getElementById('new-sale').reset();
                showScreen('home-screen');
                updateDashboard();
                
            } else if(type === 'customer') {
                const customerName = document.getElementById('customer-name').value.trim();
                const contact = document.getElementById('customer-contact').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();
                
                // 验证必填字段
                if(!customerName || !contact || !phone) {
                    alert('请填写客户名称、联系人和联系电话!');
                    return;
                }
                
                const customer = {
                    name: customerName,
                    contact: contact,
                    phone: phone,
                    address: document.getElementById('customer-address').value,
                    notes: document.getElementById('customer-notes').value
                };
                
                // 检查是否已存在同名客户
                const exists = data.customers.some(c => c.name === customer.name);
                if(exists) {
                    if(!confirm('已存在同名客户，是否覆盖?')) {
                        return;
                    }
                    // 更新现有客户
                    const index = data.customers.findIndex(c => c.name === customer.name);
                    data.customers[index] = customer;
                } else {
                    // 添加新客户
                    data.customers.push(customer);
                }
                
                localStorage.setItem('poultryData', JSON.stringify(data));
                
                alert('客户信息保存成功!');
                document.getElementById('new-customer').reset();
                updateCustomerList();
                updatePaymentCustomerList();
                showScreen('home-screen');
            }
        }
        
        // 处理客户结账
        function processPayment() {
            const customerSelect = document.getElementById('payment-customer');
            if(customerSelect.options.length === 0) {
                alert('没有可选客户，请先添加客户和销售记录！');
                return;
            }
            
            const customer = customerSelect.value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;
            const date = document.getElementById('payment-date').value;
            const notes = document.getElementById('payment-notes').value;
            
            if(!customer || isNaN(amount) || amount <= 0) {
                alert('请选择客户并输入有效的结账金额!');
                return;
            }
            
            // 获取数据
            let data = JSON.parse(localStorage.getItem('poultryData'));
            
            // 查找该客户的所有未结清销售记录
            const unpaidSales = data.sales.filter(sale => 
                sale.customer === customer && sale.payment !== '已结清'
            );
            
            if(unpaidSales.length === 0) {
                alert('该客户没有未结清的账款!');
                return;
            }
            
            // 处理结账：将最早的未结清销售记录标记为已结清，直到结清金额用完
            let remainingAmount = amount;
            let updatedSales = false;
            
            unpaidSales.sort((a, b) => a.timestamp - b.timestamp); // 按时间排序
            
            for(let i = 0; i < unpaidSales.length; i++) {
                const sale = unpaidSales[i];
                const saleAmount = sale.price * sale.quantity;
                const index = data.sales.findIndex(s => s.timestamp === sale.timestamp);
                
                if(sale.payment === '未结账') {
                    if(remainingAmount >= saleAmount) {
                        // 完全结清这笔销售
                        data.sales[index].payment = '已结清';
                        remainingAmount -= saleAmount;
                        updatedSales = true;
                    } else {
                        // 部分结清这笔销售
                        data.sales[index].payment = '部分结账';
                        updatedSales = true;
                        break;
                    }
                } else if(sale.payment === '部分结账') {
                    // 简化处理，假设部分结账为50%
                    const remainingDebt = saleAmount * 0.5;
                    if(remainingAmount >= remainingDebt) {
                        // 完全结清这笔销售
                        data.sales[index].payment = '已结清';
                        remainingAmount -= remainingDebt;
                        updatedSales = true;
                    }
                }
                
                if(remainingAmount <= 0) break;
            }
            
            if(!updatedSales) {
                alert('结账处理出错!');
                return;
            }
            
            // 保存处理后的数据
            localStorage.setItem('poultryData', JSON.stringify(data));
            
            alert('结账处理成功!');
            document.getElementById('new-payment').reset();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            updateDashboard();
            updateSelectedCustomerDebt();
            showScreen('home-screen');
        }
        
        // 设置应用为全屏模式（仅在iOS Safari上有效）
        function setFullscreen() {
            if(('standalone' in navigator) && !navigator.standalone) {
                alert('添加到主屏幕方法：\n1. 点击底部中间的分享按钮\n2. 滚动并选择"添加到主屏幕"\n3. 点击"添加"\n\n添加后可获得全屏体验，数据会保存在本地');
            }
        }
        
        // 更新客户列表
        function updateCustomerList() {
            const customerList = document.getElementById('customer-list');
            const data = JSON.parse(localStorage.getItem('poultryData'));
            
            // 清空现有列表
            customerList.innerHTML = '';
            
            if(data.customers.length === 0) {
                customerList.innerHTML = '<p style="padding: 10px; text-align: center; color: #666;">还没有客户，请添加新客户</p>';
                return;
            }
            
            // 计算客户欠款
            const customerDebt = calculateCustomerDebt();
            
            // 添加客户列表项
            data.customers.forEach(customer => {
                const debt = customerDebt[customer.name] || 0;
                const debtHtml = debt > 0 ? 
                    `<span class="badge badge-danger">未结清: ¥${debt.toFixed(2)}</span>` : 
                    `<span class="badge badge-success">无欠款</span>`;
                
                customerList.innerHTML += `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-name">${customer.name}</div>
                            <div class="item-detail">联系人: ${customer.contact} (${formatPhone(customer.phone)})</div>
                        </div>
                        <div class="item-value">
                            ${debt > 0 ? `¥${debt.toFixed(2)}` : ''}
                            ${debtHtml}
                        </div>
                    </div>
                `;
            });
        }
        
        // 更新结账页面的客户下拉列表
        function updatePaymentCustomerList() {
            const customerSelect = document.getElementById('payment-customer');
            const data = JSON.parse(localStorage.getItem('poultryData'));
            
            // 清空现有选项
            customerSelect.innerHTML = '';
            
            // 计算客户欠款
            const customerDebt = calculateCustomerDebt();
            
            // 添加客户选项，只添加有欠款的客户
            data.customers.forEach(customer => {
                const debt = customerDebt[customer.name] || 0;
                if(debt > 0) {
                    const option = document.createElement('option');
                    option.value = customer.name;
                    option.textContent = `${customer.name} (欠款: ¥${debt.toFixed(2)})`;
                    customerSelect.appendChild(option);
                }
            });
        }
        
        // 更新首页仪表盘
        function updateDashboard() {
            const data = JSON.parse(localStorage.getItem('poultryData'));
            
            // 更新首页的库存和交易展示
            updateInventoryDisplay();
            updateTransactionsDisplay();
            
            // 计算今日销售额和未结账款总额
            const today = new Date().toISOString().split('T')[0];
            
            // 今日销售额
            const todaySales = data.sales.filter(sale => sale.date === today);
            const todaySalesAmount = todaySales.reduce((sum, sale) => sum + (sale.price * sale.quantity), 0);
            
            // 未结账款总额
            const totalDebt = Object.values(calculateCustomerDebt()).reduce((sum, debt) => sum + debt, 0);
            
            // 更新统计数据
            document.querySelector('.stats-container .stat-box:nth-child(1) .stat-value').textContent = `¥${todaySalesAmount.toFixed(2)}`;
            document.querySelector('.stats-container .stat-box:nth-child(2) .stat-value').textContent = `¥${totalDebt.toFixed(2)}`;
        }
        
        // 更新库存显示
        function updateInventoryDisplay() {
            const data = JSON.parse(localStorage.getItem('poultryData'));
            const inventoryCard = document.querySelector('#home-screen .card:nth-child(3)');
            const cardTitle = inventoryCard.querySelector('.card-title');
            
            // 清空现有列表，保留标题
            while(inventoryCard.childElementCount > 1) {
                inventoryCard.removeChild(inventoryCard.lastChild);
            }
            
            if(data.inventory.length === 0) {
                inventoryCard.innerHTML += '<p style="padding: 10px; text-align: center; color: #666;">还没有库存记录，请添加进货</p>';
                return;
            }
            
            // 添加库存列表项
            data.inventory.slice(0, 4).forEach(item => {
                // 计算库存百分比以显示进度条
                const stockPercentage = Math.min(Math.max(item.stock / 10, 0) * 10, 100);

               let progressClass = 'progress-green';
                
                if(stockPercentage < 35) {
                    progressClass = 'progress-orange';
                } else if(stockPercentage < 60) {
                    progressClass = 'progress-yellow';
                }
                
                inventoryCard.innerHTML += `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-name">${item.product}</div>
                            <div class="item-detail">库存: ${item.stock}个</div>
                            <div class="progress-bar">
                                <div class="progress ${progressClass}" style="width: ${stockPercentage}%"></div>
                            </div>
                        </div>
                        <div class="item-value">
                            ¥${item.price.toFixed(2)}/个
                        </div>
                    </div>
                `;
            });
            
            // 如果有更多商品，显示查看更多提示
            if(data.inventory.length > 4) {
                inventoryCard.innerHTML += `
                    <div style="text-align: center; padding: 5px 0;">
                        <a href="#" onclick="showScreen('inventory-screen')">查看更多 (${data.inventory.length - 4})</a>
                    </div>
                `;
            }
        }
        
        // 更新最近交易显示
        function updateTransactionsDisplay() {
            const data = JSON.parse(localStorage.getItem('poultryData'));
            const transactionsCard = document.querySelector('#home-screen .card:nth-child(4)');
            const cardTitle = transactionsCard.querySelector('.card-title');
            
            // 清空现有列表，保留标题
            while(transactionsCard.childElementCount > 1) {
                transactionsCard.removeChild(transactionsCard.lastChild);
            }
            
            if(data.sales.length === 0) {
                transactionsCard.innerHTML += '<p style="padding: 10px; text-align: center; color: #666;">还没有交易记录，请添加销售</p>';
                return;
            }
            
            // 按时间排序，最新的在前面
            const recentSales = [...data.sales].sort((a, b) => b.timestamp - a.timestamp).slice(0, 3);
            
            // 添加最近交易列表项
            recentSales.forEach(sale => {
                let badgeClass = 'badge-success';
                if(sale.payment === '未结账') {
                    badgeClass = 'badge-danger';
                } else if(sale.payment === '部分结账') {
                    badgeClass = 'badge-warning';
                }
                
                const totalAmount = (sale.price * sale.quantity).toFixed(2);
                
                transactionsCard.innerHTML += `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-name">${sale.customer}</div>
                            <div class="item-detail">销售 ${sale.product} x${sale.quantity}</div>
                        </div>
                        <div class="item-value">
                            ¥${totalAmount}
                            <span class="badge ${badgeClass}">${sale.payment}</span>
                        </div>
                    </div>
                `;
            });
            
            // 如果有更多交易，显示查看更多提示
            if(data.sales.length > 3) {
                transactionsCard.innerHTML += `
                    <div style="text-align: center; padding: 5px 0;">
                        <a href="#" onclick="showScreen('transactions-screen')">查看更多 (${data.sales.length - 3})</a>
                    </div>
                `;
            }
        }
        
        // 计算客户欠款总额
        function calculateCustomerDebt() {
            const data = JSON.parse(localStorage.getItem('poultryData'));
            const customerDebt = {};
            
            // 初始化客户欠款为0
            data.customers.forEach(customer => {
                customerDebt[customer.name] = 0;
            });
            
            // 统计所有未结清的销售
            data.sales.forEach(sale => {
                if(sale.payment !== '已结清') {
                    const amount = sale.quantity * sale.price;
                    if(sale.payment === '未结账') {
                        customerDebt[sale.customer] = (customerDebt[sale.customer] || 0) + amount;
                    } else if(sale.payment === '部分结账') {
                        customerDebt[sale.customer] = (customerDebt[sale.customer] || 0) + amount * 0.5; // 简化处理，假设部分结账为50%
                    }
                }
            });
            
            return customerDebt;
        }
        
        // 更新选中客户的欠款信息
        function updateSelectedCustomerDebt() {
            const paymentCustomer = document.getElementById('payment-customer');
            if(!paymentCustomer || paymentCustomer.options.length === 0) return;
            
            const selectedCustomer = paymentCustomer.value;
            const customerDebt = calculateCustomerDebt();
            const debt = customerDebt[selectedCustomer] || 0;
            
            document.getElementById('payment-debt').value = '¥' + debt.toFixed(2);
        }
        
        // 格式化手机号(隐藏中间4位)
        function formatPhone(phone) {
            if(!phone || phone.length < 7) return phone;
            return phone.slice(0, 3) + '****' + phone.slice(-4);
        }
        
        // 导出数据
        function exportData() {
            const data = localStorage.getItem('poultryData');
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = '禽易记数据备份_' + new Date().toISOString().slice(0, 10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            
            if(!file) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if(!data.purchases || !data.sales || !data.customers || !data.inventory) {
                        throw new Error('数据格式不正确');
                    }
                    
                    localStorage.setItem('poultryData', JSON.stringify(data));
                    alert('数据导入成功!');
                    location.reload();
                } catch(error) {
                    alert('导入失败: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // 在页面加载完成后检查是否显示全屏提示
        document.addEventListener('DOMContentLoaded', function() {
            setFullscreen();
        });
    </script>
</body>
</html>
